#!/bin/bash

libexec="$(cd "$(dirname "$0")" && pwd)"
. "${libexec}/base.sh"
. "${libexec}/version.sh"

set_vars () {
    [[ -n $prefix ]]           || prefix=/var/tmp
    [[ -n $scope ]]            || scope=standard
    [[ -n $CH_TEST_TARDIR ]]   || CH_TEST_TARDIR=${prefix}/tar
    [[ -n $CH_TEST_IMGDIR ]]   || CH_TEST_IMGDIR=${prefix}/img
    [[ -n $CH_TEST_SCOPE ]]    || CH_TEST_SCOPE=$scope
    [[ -n $CH_TEST_PERMDIRS ]] || CH_TEST_PERMDIRS='/var/tmp /tmp'
    [[ -d $CH_TEST_TARDIR ]]   || mkdir -p "$CH_TEST_TARDIR"
    [[ -d $CH_TEST_IMGDIR ]]   || mkdir -p "$CH_TEST_IMGDIR"
    export CH_TEST_TARDIR=$CH_TEST_TARDIR
    export CH_TEST_IMGDIR=$CH_TEST_IMGDIR
    export CH_TEST_SCOPE=$CH_TEST_SCOPE
    export CH_TEST_PERMDIRS=$CH_TEST_PERMDIRS
}

fatal () {
    printf '%s\n\n' "$1" 1>&2
    exit 1
}

perm_dirs () {
    [[ ! $CH_TEST_PERMDIRS = 'skip' ]] || return 0
    for d in $CH_TEST_PERMDIRS; do
        if [[ -d $d ]]; then
            # prevent the test suite from failing if the perm_dirs directory
            # exists
            [[ ! -d "${d}/perm_dirs" ]] || rm -rf "${d}/perm_dirs"
        else
            mkdir -p "$d"
        fi
    done
    for d in $CH_TEST_PERMDIRS; do
        sudo ./make-perms-test "$d" "$USER" nobody
    done
}

print_info () {
    printf 'running tests from:     %s\n' "$testdir"
    printf 'CH_TEST_SCOPE           %s\n' "$CH_TEST_SCOPE"
    printf 'CH_TEST_TARDIR          %s\n' "$CH_TEST_TARDIR"
    printf 'CH_TEST_IMGDIR          %s\n' "$CH_TEST_IMGDIR"
    printf 'CH_TEST_PERMDIRS        %s\n' "${CH_TEST_PERMDIRS[@]}"
}

topdir=${ch_bin%/bin}
version=$(version 2>&1)

# Determine test directory
if [[ -d "${topdir}/test" ]]; then
    testdir=${topdir}/test  #local install
else
    testdir=${topdir}/libexec/charliecloud-${version} #prefix install
fi

# Parse arguments
parse_basic_args "$@"
while [[ $# -gt 0 ]]; do
    opt=$1; shift
    case $opt in
    build|run|examples|all|clean)
        [[ -z $phase ]] || fatal 'test phase may only be assigned once'
        phase=$opt
    ;;
    -p|--prefix=*)
        [[ -z $prefix ]] || fatal 'prefix: assigned more than once'
        if [[ $opt == '--prefix='* ]]; then
            prefix=${opt##*=}  # remove '--prefix='
            [[ -n $prefix ]] || fatal "prefix: invalid argument $opt"
        else
            prefix=$1; shift
        fi
    ;;
    -s|--scope=*)
        [[ -z $scope ]] || fatal 'scope: assigned more than once'
        if [[ $opt = '--scope' ]]; then
            scope=${opt##*=}  # remove '--scope='
        else
            scope=$1; shift
        fi
    ;;
    *)
        fatal "unrecognized argument: $opt"
    esac
done

# Sanity check
cd "$testdir"   || fatal 'test directory not found (did you install the charliecloud-test package?'
[[ -n $phase ]] || fatal 'test phase not specified'

# Execute phase
case $phase in
    build)
        set_vars
        print_info
        perm_dirs
        make test-build
    ;;
    run)
        set_vars
        print_info
        make test-run
    ;;
    examples)
        set_vars
        print_info
        make test-test
    ;;
    all)
        set_vars
        print_info
        perm_dirs
        make test-build
        make test-run
        make test-test
    ;;
    clean)
        echo 'removing CH_TEST_TARDIR...'
        rm -rf "$CH_TEST_TARDIR"
        echo 'removing CH_TEST_IMGDIR...'
        rm -rf "$CH_TEST_IMGDIR"
        echo 'removing CH_TEST_PERMDIRS...'
        for d in $CH_TEST_PERMDIRS; do
            if [[ -d ${d}/perm_dirs ]]; then
                rm -rf "${d}/perm_dirs"
            fi
        done
    ;;
esac
